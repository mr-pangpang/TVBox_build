name: TVBox è‡ªåŠ¨åŒ–æ„å»ºä¸å‘å¸ƒ
on:
  workflow_dispatch:
    inputs:
      rebuild:
        description: 'ä»…é‡æ–°æ„å»ºä¸å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean

env:
  BUILD_DIR: TVBoxOSC
  ARTIFACT_PREFIX: TVBox
  MAX_RETRY: 3

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - userName: q215613905
            repoUrl: https://github.com/mr-pangpang/q215613905_TVBox
            branchName: main
            javaVersion: 17

    steps:
      # ====================
      # é˜¶æ®µ 1ï¼šç¯å¢ƒå‡†å¤‡
      # ====================
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: ${{ env.BUILD_DIR }}
          ref: ${{ matrix.branchName }}
          # ç²¾å‡†æ£€å‡ºå¿…è¦ç›®å½•ï¼ˆæå‡æ£€å‡ºæ•ˆç‡ï¼‰
          sparse-checkout: |
            ${{ env.BUILD_DIR }}
            .github/scripts/  # JKSæ–‡ä»¶ç›®å½•
            buildSrc/        # è‡ªå®šä¹‰æ„å»ºæ¨¡å—
            gradle/

      - name: è®¾ç½®æ„å»ºæ ‡è¯†
        id: build-flag
        run: |
          current_commit=$(git -C ${{ env.BUILD_DIR }} rev-parse HEAD)
          last_commit=$(cat log/${{ matrix.userName }}.txt 2>/dev/null || true)
          
          # å¢å¼ºæ¡ä»¶åˆ¤æ–­é€»è¾‘
          if [ "$current_commit" != "$last_commit" ] || ${{ github.event.inputs.rebuild == 'true' }}; then
            echo "æ„å»ºæ ‡è¯†è®¾ç½®..."
            current_tag=$(date +'%Y.%m%d.%H%M')
            echo "commit=$current_commit" >> $GITHUB_ENV
            echo "commit_id=${current_commit:0:7}" >> $GITHUB_ENV
            echo "should_build=true" >> $GITHUB_ENV
            echo "tag=$current_tag" >> $GITHUB_ENV
          else
            echo "ğŸ”„ ä»£ç æ— å˜åŒ–ï¼Œè·³è¿‡æ„å»º"
          fi

      # ====================
      # é˜¶æ®µ 2ï¼šæ„å»ºé…ç½®
      # ====================
      - name: é…ç½®Javaç¯å¢ƒ
        if: ${{ env.should_build }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.javaVersion }}
          cache: gradle
          # å…³é”®ä¿®æ”¹ï¼šé€‚é…å­ç›®å½•çš„ç¼“å­˜è·¯å¾„
          cache-dependency-path: |
            ${{ env.BUILD_DIR }}/**/*.gradle*
            ${{ env.BUILD_DIR }}/gradle/wrapper/gradle-wrapper.properties
            ${{ env.BUILD_DIR }}/buildSrc/**/*.kt

      - name: é…ç½®ç­¾åä¿¡æ¯
        if: ${{ env.should_build }}
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          # ä»ä»“åº“å®‰å…¨ä½ç½®å¤åˆ¶å¯†é’¥åº“
          cp -vf "${{ github.workspace }}/.github/scripts/TVBoxOSC.jks" ./app/
          
          # ä½¿ç”¨ heredoc æ–¹å¼å†™å…¥é…ç½®ï¼ˆé¿å…è½¬ä¹‰é—®é¢˜ï¼‰
          cat <<EOF >> gradle.properties
          RELEASE_STORE_FILE=./app/TVBoxOSC.jks
          RELEASE_KEY_ALIAS=TVBoxOSC
          RELEASE_STORE_PASSWORD=TVBoxOSC
          RELEASE_KEY_PASSWORD=TVBoxOSC
          EOF

      # ====================
      # é˜¶æ®µ 3ï¼šæ„å»ºæ‰§è¡Œ
      # ====================
      - name: Gradleæ„å»ºï¼ˆå«é‡è¯•ï¼‰
        if: ${{ env.should_build }}
        uses: nick-fields/retry@v3
        env:
          GRADLE_OPTS: -Dorg.gradle.daemon=false
        with:
          max_attempts: ${{ env.MAX_RETRY }}
          command: |
            cd ${{ env.BUILD_DIR }}
            ./gradlew clean assembleRelease \
              --no-daemon \
              --no-parallel \
              --stacktrace \
              --info  # å¢åŠ æ—¥å¿—è¯¦ç»†åº¦

      - name: æ•´ç†æ„å»ºäº§ç‰©
        if: ${{ env.should_build }}
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          # åˆ›å»ºåˆ†å±‚è¾“å‡ºç›®å½•
          mkdir -p artifacts/{apk,source}
          
          # æŸ¥æ‰¾å¹¶é‡å‘½åAPKæ–‡ä»¶ï¼ˆå…¼å®¹å¤šæ¨¡å—æ„å»ºï¼‰
          find . -path '*/build/outputs/apk/release/*-release.apk' \
            -exec mv -v {} "artifacts/apk/${{ env.ARTIFACT_PREFIX }}_${{ env.tag }}.apk" \;
          
          # æ‰“åŒ…æºä»£ç ï¼ˆæ’é™¤æ„å»ºäº§ç‰©ï¼‰
          zip -qr "artifacts/source/${{ env.ARTIFACT_PREFIX }}_${{ env.commit_id }}_src.zip" . \
            -x "build/*" "*.jks" ".git/*"

      # ====================
      # é˜¶æ®µ 4ï¼šå‘å¸ƒéƒ¨ç½²
      # ====================
      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        if: ${{ env.should_build && !inputs.rebuild }}
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          git fetch --depth=100 origin ${{ matrix.branchName }}
          git log --pretty=format:"- %s [%h]" ${{ env.commit_id }}^..HEAD > CHANGELOG.md
          echo -e "\n**æ„å»ºå…ƒæ•°æ®**\n- æ„å»ºID: ${{ github.run_id }}" >> CHANGELOG.md

      - name: å‘å¸ƒRelease
        if: ${{ !inputs.rebuild && env.should_build }}
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: release-${{ env.tag }}
          name: "Release ${{ env.tag }}"
          body_path: ${{ env.BUILD_DIR }}/CHANGELOG.md
          files: |
            ${{ env.BUILD_DIR }}/artifacts/apk/*.apk
            ${{ env.BUILD_DIR }}/artifacts/source/*.zip
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') }}

      - name: æ›´æ–°æ„å»ºè®°å½•
        if: ${{ env.should_build }}
        env:
          GIT_USER: "CI Bot"
          GIT_EMAIL: "ci@tvbox.org"
        run: |
          git config --global user.name "$GIT_USER"
          git config --global user.email "$GIT_EMAIL"
          
          # åŸå­åŒ–æ›´æ–°æ„å»ºè®°å½•
          mkdir -p log
          echo "${{ env.commit }}" > log/${{ matrix.userName }}.txt
          git add log/
          if ! git diff-index --quiet HEAD --; then
            git commit -m "ğŸ“Œ æ›´æ–°æ„å»ºæ ‡è®°: ${{ matrix.userName }}@${{ env.commit_id }}"
            git push origin ${{ matrix.branchName }}
          fi
