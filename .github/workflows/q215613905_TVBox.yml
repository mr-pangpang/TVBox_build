name: TVBox 构建流程修复版
on:
  workflow_dispatch:
    inputs:
      rebuild:
        description: '强制重新构建'
        required: false
        type: boolean

env:
  BUILD_DIR: TVBoxOSC  # 无需斜杠
  ARTIFACT_PREFIX: TVBox-Pro

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # ====================
      # 阶段 1：正确代码检出
      # ====================
      - name: 智能代码检出
        uses: actions/checkout@v4
        with:
          path: ${{ env.BUILD_DIR }}
          sparse-checkout: |
            # 正确模式写法（无前导斜杠）
            ${{ env.BUILD_DIR }}/**  # 匹配目录下所有内容
            !.github/workflows/_archive  # 排除目录
          fetch-depth: 100

      # ====================
      # 阶段 2：路径验证
      # ====================
      - name: 验证检出结构
        run: |
          echo "当前工作目录: ${{ github.workspace }}"
          ls -la ${{ github.workspace }}
          
          echo "BUILD_DIR 内容:"
          ls -la ${{ env.BUILD_DIR }}

      # ====================
      # 阶段 3：构建执行
      # ====================
      - name: 执行 Gradle 构建
        working-directory: ${{ env.BUILD_DIR }}
        run: ./gradlew assembleRelease

      # ====================
      # 阶段 4：产物处理
      # ====================
      - name: 整理 APK 文件
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          mkdir -p artifacts
          find . -path '*/build/outputs/apk/*.apk' -exec mv {} artifacts \;

      # ====================
      # 阶段 5：安全发布
      # ====================
      - name: 发布版本
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.BUILD_DIR }}/artifacts/*.apk
