name: TVBox è‡ªåŠ¨åŒ–æ„å»ºä¸å‘å¸ƒ
# å·¥ä½œæµåç§°ï¼Œæ˜¾ç¤ºåœ¨ GitHub Actions é¡µé¢

on:
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      rebuild:
        description: 'ä»…é‡æ–°æ„å»ºä¸å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean

env:  # å…¨å±€ç¯å¢ƒå˜é‡
  BUILD_DIR: TVBoxOSC    # é¡¹ç›®ç›®å½•åç§°
  ARTIFACT_PREFIX: TVBox # äº§å‡ºç‰©å‰ç¼€
  MAX_RETRY: 3          # æ„å»ºé‡è¯•æ¬¡æ•°

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false   # çŸ©é˜µä»»åŠ¡ç‹¬ç«‹å¤±è´¥
      matrix:
        include:
          - userName: q215613905
            repoUrl: https://github.com/mr-pangpang/q215613905_TVBox
            branchName: main
            javaVersion: 17

    steps:
      # --------------------------
      # é˜¶æ®µ 1ï¼šå‡†å¤‡ç¯å¢ƒ
      # --------------------------
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²
          path: ${{ env.BUILD_DIR }}  # æŒ‡å®šæ£€å‡ºç›®å½•
          ref: ${{ matrix.branchName }}

      - name: è®¾ç½®æ„å»ºæ ‡è¯†
        id: build-flag
        run: |
          # è®¡ç®—å½“å‰æäº¤å“ˆå¸Œ
          current_commit=$(git -C ${{ env.BUILD_DIR }} rev-parse HEAD)
          
          # è¯»å–ä¸Šæ¬¡æ„å»ºè®°å½•
          last_commit=$(cat log/${{ matrix.userName }}.txt 2>/dev/null || true)
          
          # åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»ºçš„æ¡ä»¶ï¼š
          # 1. æäº¤å‘ç”Ÿå˜åŒ– æˆ– 2. æ‰‹åŠ¨è§¦å‘é‡å»º
          if [ "$current_commit" != "$last_commit" ] || ${{ inputs.rebuild }}; then
            echo "éœ€è¦æ„å»ºï¼šæ˜¯"
            echo "commit=$current_commit" >> $GITHUB_ENV
            echo "commit_id=${current_commit:0:7}" >> $GITHUB_ENV
            echo "should_build=true" >> $GITHUB_ENV
            
            # ç”Ÿæˆæ—¶é—´æˆ³æ ‡ç­¾ (ç¤ºä¾‹ï¼š2025.0411.1519)
            echo "tag=$(date +'%Y.%m%d.%H%M')" >> $GITHUB_ENV
          else
            echo "éœ€è¦æ„å»ºï¼šå¦ (æ— æ–°æäº¤)"
          fi

      # --------------------------
      # é˜¶æ®µ 2ï¼šæ„å»ºå‡†å¤‡
      # --------------------------
      - name: é…ç½® Java ç¯å¢ƒ
        if: ${{ env.should_build }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin  # æ¨èä½¿ç”¨ Temurin JDK
          java-version: ${{ matrix.javaVersion }}
          cache: gradle         # å¯ç”¨ Gradle ç¼“å­˜

      - name: é…ç½®ç­¾åä¿¡æ¯
        if: ${{ env.should_build }}
        working-directory: ${{ env.BUILD_DIR }}
        env:
          # ä» Secrets è¯»å–ç­¾åé…ç½®ï¼ˆéœ€è¦æå‰åœ¨ä»“åº“è®¾ç½®ï¼‰
          #KEYSTORE: ${{ secrets.KEYSTORE_BASE64 }}  # Base64 ç¼–ç çš„ JKS æ–‡ä»¶
          #KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          #STORE_PASS: ${{ secrets.STORE_PASS }}
          #KEY_PASS: ${{ secrets.KEY_PASS }}
        run: |
          # è§£ç å¹¶å†™å…¥å¯†é’¥åº“æ–‡ä»¶
          #echo "$KEYSTORE" | base64 -d > app/TVBoxOSC.jks
          cp -f ${{ github.workspace }}/.github/scripts/TVBoxOSC.jks ./app/TVBoxOSC.jks
          
          # æ›´æ–° gradle.properties
          echo "RELEASE_STORE_FILE=./TVBoxOSC.jks" >> gradle.properties
          echo "RELEASE_KEY_ALIAS=TVBoxOSC" >> gradle.properties
          echo "RELEASE_STORE_PASSWORD=TVBoxOSC" >> gradle.properties
          echo "RELEASE_KEY_PASSWORD=TVBoxOSC" >> gradle.properties

      # --------------------------
      # é˜¶æ®µ 3ï¼šæ„å»ºè¿‡ç¨‹
      # --------------------------
      - name: æ‰§è¡Œ Gradle æ„å»º (å«é‡è¯•)
        if: ${{ env.should_build }}
        uses: nick-fields/retry@v3  # æ·»åŠ æ„å»ºé‡è¯•æœºåˆ¶
        env:
          GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=false
        with:
          max_attempts: ${{ env.MAX_RETRY }}
          command: |
            cd ${{ env.BUILD_DIR }}
            ./gradlew clean assembleRelease \
              --no-daemon \         # ç¦ç”¨å®ˆæŠ¤è¿›ç¨‹ (æé«˜å®¹å™¨ç¨³å®šæ€§)
              --no-parallel \       # ç¦ç”¨å¹¶è¡Œä»»åŠ¡ (é¿å…èµ„æºå†²çª)
              --stacktrace          # æ˜¾ç¤ºè¯¦ç»†é”™è¯¯æ—¥å¿—

      - name: æ•´ç†äº§å‡ºæ–‡ä»¶
        if: ${{ env.should_build }}
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          # åˆ›å»ºæ ‡å‡†åŒ–è¾“å‡ºç›®å½•
          mkdir -p artifacts/apk
          
          # ç§»åŠ¨ APK æ–‡ä»¶å¹¶é‡å‘½å
          find . -name "*-release.apk" -exec mv {} artifacts/apk/${{ env.ARTIFACT_PREFIX }}_${GITHUB_RUN_ID}.apk \;
          
          # æ‰“åŒ…æºä»£ç  (æ’é™¤ Git ç›®å½•)
          zip -qr ${{ env.ARTIFACT_PREFIX }}_${{ env.commit_id }}_src.zip . -x ".git/*"

      # --------------------------
      # é˜¶æ®µ 4ï¼šå‘å¸ƒä¸æ¸…ç†
      # --------------------------
      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        if: ${{ env.should_build && !inputs.rebuild }}
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          # ç”Ÿæˆ Markdown æ ¼å¼çš„å˜æ›´æ—¥å¿—
          git log --pretty=format:"- %s (%h)" ${{ env.commit_id }}^..HEAD > Changelog.md
          echo -e "**æ„å»ºä¿¡æ¯**\n- æäº¤è€…: ${{ github.actor }}\n- æ—¶é—´: $(date)" >> Changelog.md

      - name: å‘å¸ƒåˆ° GitHub Releases
        if: ${{ !inputs.rebuild && env.should_build }}
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.TOKEN }}  # å¿…é¡»ä½¿ç”¨å…·æœ‰ repo æƒé™çš„ PAT
          tag_name: release-${{ env.tag }}
          name: "ç‰ˆæœ¬ ${{ env.tag }}"
          body_path: ${{ env.BUILD_DIR }}/Changelog.md
          files: |
            ${{ env.BUILD_DIR }}/artifacts/apk/*
            ${{ env.BUILD_DIR }}/${{ env.ARTIFACT_PREFIX }}_*.zip
          draft: false
          prerelease: false

      - name: æ›´æ–°æ„å»ºè®°å½•
        if: ${{ env.should_build }}
        env:
          GIT_USER: "github-actions[bot]"
          GIT_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
        run: |
          # é…ç½® Git èº«ä»½
          git config --global user.name "$GIT_USER"
          git config --global user.email "$GIT_EMAIL"
          
          # è®°å½•æœ¬æ¬¡æ„å»ºçš„æäº¤å“ˆå¸Œ
          mkdir -p log
          echo "${{ env.commit }}" > log/${{ matrix.userName }}.txt
          
          # æäº¤å¹¶æ¨é€å˜æ›´
          git add log/
          git commit -m "ğŸ“ æ›´æ–°æ„å»ºè®°å½•: ${{ matrix.userName }}@${{ env.commit_id }}" || echo "æ— å˜æ›´éœ€è¦æäº¤"
          git push origin ${{ matrix.branchName }}
