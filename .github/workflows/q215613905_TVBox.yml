name: q215613905_TVBox

on:
  workflow_dispatch:
    inputs:
      rebuild:
        description: 'Rebuild without release'
        required: false
        type: boolean

env:
  BUILD_DIR: TVBoxOSC
  ARTIFACT_NAME: TVBox_${{ matrix.userName }}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - userName: q215613905
            repoUrl: https://github.com/mr-pangpang/q215613905_TVBox
            branchName: main
            javaVersion: 17

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: ${{ env.BUILD_DIR }}

      - name: Setup Build Environment
        id: setup
        run: |
          current_commit=$(git -C ${{ env.BUILD_DIR }} rev-parse HEAD)
          last_commit=$(cat log/${{ matrix.userName }}.txt 2>/dev/null || true)
          
          if [ "$current_commit" != "$last_commit" ] || ${{ inputs.rebuild }}; then
            echo "commit=$current_commit" >> $GITHUB_ENV
            echo "commit_id=${current_commit:0:7}" >> $GITHUB_ENV
            echo "should_build=true" >> $GITHUB_ENV
            echo "tag=$(date +'%Y.%m%d.%H%M')" >> $GITHUB_ENV
          fi

      - name: Setup Java
        if: ${{ env.should_build }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.javaVersion }}

      - name: Build APK (with retry)
        if: ${{ env.should_build }}
        uses: nick-fields/retry@v3
        env:
          GRADLE_OPTS: -Dorg.gradle.daemon=false
        with:
          max_attempts: 3
          command: |
            cd ${{ env.BUILD_DIR }}
            ./gradlew clean assembleRelease --no-daemon --no-parallel

      - name: Package Artifacts
        if: ${{ env.should_build }}
        run: |
          cd ${{ env.BUILD_DIR }}
          zip -qr ${{ env.ARTIFACT_NAME }}_src.zip . -x ".git/*"
          mkdir -p artifacts/apk
          find . -name "*.apk" -exec mv {} artifacts/apk \;

      - name: Create Release
        if: ${{ !inputs.rebuild && env.should_build }}
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.token }}  # 必须使用具有 repo 权限的 PAT
          tag_name: release-${{ env.tag }}
          body_path: ${{ env.BUILD_DIR }}/Changelog.txt
          files: |
            ${{ env.BUILD_DIR }}/artifacts/apk/*
            ${{ env.BUILD_DIR }}/${{ env.ARTIFACT_NAME }}_src.zip
